<!DOCTYPE html>
<html>
<head>
<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script>
function generate_passphrase() {
	var choices = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
	var ret = [];
	for (var i=0; i<24; i++) {
		var idx = Math.floor(Math.random() * choices.length);
		ret.push(choices[idx]);
	}
	return ret.join('');
}
$(function() {
	var baseurl = 'http://viacry.pt';
	var hash = window.location.hash;
	if (hash) {
		var items = hash.split(';');
		var id = items[0];
		if (id[0] == '#') {
			id = id.slice(1);
		}
		var passphrase = items[1];
		//console.log(id, passphrase);

		var url = baseurl + '/m/' + id;
		$.get(url, function(res) {
			var lines = res.split('\n');
			var data = lines.slice(5, lines.length-2).join('');
			//console.log(data);

			var decrypted = CryptoJS.AES.decrypt(data, passphrase);
			var message = decrypted.toString(CryptoJS.enc.Utf8);
			//console.log(decrypted);
			//console.log(message);

			var modal = $('#messageModal');
			modal.find('.message').text(message);
			modal.modal();
		});
	}
	$('#save').click(function() {
		var message = $('#message').val();
		var passphrase = generate_passphrase();
		//console.log('message', message);
		//console.log('passphrase', passphrase);

		var data = CryptoJS.AES.encrypt(message, passphrase);
		console.log(data.toString());
		//console.log('data', data);
		//var decrypt = CryptoJS.AES.decrypt(data.toString(), passphrase);
		//console.log('decrypt_test', decrypt.toString(CryptoJS.enc.Utf8));
		//return;

		var content = {
			data: data.toString()
		};
		$.post('/m/', content, function(res) {
			var data = $.parseJSON(res);
			var id = data.id;
			var url = baseurl + '/#' + id + ';' + passphrase;
			//console.log(url);

			var div = $('#showUrl');
			div.find('.url').html('<a href="'+url+'" target="_blank">'+url+'</a>');
			div.show();
		});
	});
});
</script>
</head>

<body>

<div class="container">
	<h1>ViaCRYPT
		<small>One time read messaging system</small>
	</h1>
	<form class="form-horizontal">
		<div class="control-group">
			<label class="control-label" for="message">Message</label>
			<div class="controls">
				<textarea id="message" class="input-xxlarge" rows="15" placeholder="Type here your secret message..."></textarea>
			</div>
		</div>
		<div class="control-group">
			<div class="controls">
				<button id="save" type="button" class="btn btn-primary">Save it</button>
			</div>
		</div>
	</form>
	<div id="showUrl" class="well hide">
		URL of this message: <span class="url"></span>
	</div>

	<hr>
	<footer>
		Developed by Marcelo Salhab Brogliato at <a href="http://www.vialink.com.br/" target="_blank">Vialink</a>.
		<div class="pull-right">
			<a href="http://www.vialink.com.br/"><img src="http://www.vialink.com.br/_logos/vialink.png" alt="Vialink"></a>
		</div>
	</footer>
</div>

<div id="messageModal" class="modal hide fade" tabindex="-1" role="dialog">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
		<h3>Your message is...</h3>
	</div>
	<div class="modal-body">
		<pre class="message"></pre>
		<span class="label label-important">REMEMBER</span> This message was deleted and you cannot read it again.
	</div>
	<div class="modal-footer">
		<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
	</div>
</div>

</body>
</html>
